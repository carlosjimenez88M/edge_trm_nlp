name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Cache Conda
      uses: actions/cache@v2
      with:
        path: ~/conda
        key: conda-${{ runner.os }}-${{ hashFiles('**/Pipeline/conda.yml') }}
        restore-keys: conda-${{ runner.os }}-

    - name: Install Conda
      run: |
        if [ ! -d "$HOME/conda" ]; then
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p $HOME/conda
          source $HOME/conda/etc/profile.d/conda.sh
          conda init bash
        else
          echo "Conda is already installed"
        fi
        source $HOME/conda/etc/profile.d/conda.sh
        conda config --set always_yes yes --set changeps1 no
        conda info -a

    - name: Create environment
      run: |
        source ~/conda/etc/profile.d/conda.sh
        conda env create -f Pipeline/conda.yml
        conda activate edge_trm_nlp

    - name: Run Script
      run: |
        chmod +x Pipeline/run.sh
        ./Pipeline/run.sh
